name: CI

on: [push, pull_request]

jobs:
 linux-build:

   runs-on: ubuntu-latest

   steps:
    - name: Checkout
      uses: actions/checkout@v2.0.0

    - name: Setup .NET Core SDK
      uses: actions/setup-dotnet@v1.4.0
      with:
        dotnet-version: '3.1.101'

    - name: Install CMake
      run: sudo apt-get install cmake

    - name: Build Managed part
      run: dotnet publish -c Release
      working-directory: ./gm_dotnet_managed/

    - name: Build Native part
      run: |
           mkdir cmake_build
           cd cmake_build
           cmake ../gm_dotnet_native
           make

    - name: Copy build artifacts
      env:
        COMMIT: ${{ github.sha }}
      run: |
           mkdir build
           mkdir build/gmodnet
           mkdir build/gmodnet/API
           cp cmake_build/*.dll build
           cp -a -v gm_dotnet_managed/GmodNET/bin/Release/netcoreapp3.1/publish/. build/gmodnet
           cp gm_dotnet_managed/GmodNET.API/bin/Release/netcoreapp3.1/GmodNET.API.dll build/gmodnet/API
           find build/gmodnet/*.exe | xargs rm -f -v
           rm -f -v build/gmodnet/GmodNET
           rm -f -v build/gmodnet/web.config
           cd build
           mkdir dotnet
           cd dotnet
           wget https://download.visualstudio.microsoft.com/download/pr/deeee432-fd3c-4dbc-bc06-cbf166cbcfb7/04747ae7a0ea63e01b6f932cccdcf837/aspnetcore-runtime-3.1.1-linux-x64.tar.gz
           tar xvf aspnetcore-runtime-3.1.1-linux-x64.tar.gz
           rm -f -v aspnetcore-runtime-3.1.1-linux-x64.tar.gz
           cd ..
           cd ..
           cp LICENSE build
           cp NOTICE build
           cd build
           touch gmodnet-$COMMIT

    - name: Upload build artifacts
      uses: actions/upload-artifact@v1.0.0
      with:
        name: Linux-Raw-Build
        path: ./build

    - name: Download Steam and Install Garry's Mod Dedicated Server
      run: |
           sudo apt-get install lib32gcc1
           wget https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz
           tar -xvzf steamcmd_linux.tar.gz
           rm -rfv steamcmd_linux.tar.gz
           ./steamcmd.sh +login anonymous +force_install_dir gmod "+app_update 4020 -beta x86-64 validate" +quit

    - name: Prepare test run
      run: |
           mkdir gmod/garrysmod/lua/bin
           mkdir gmod/garrysmod/lua/bin/Modules
           mkdir gmod/garrysmod/lua/bin/Modules/Tests
           cp -a gm_dotnet_managed/Tests/bin/Release/netcoreapp3.1/publish/. gmod/garrysmod/lua/bin/Modules/Tests
           cp -a build/. gmod/garrysmod/lua/bin
           cp lua/autorun/serverside/gm_dotnet_server.lua gmod/garrysmod/lua/autorun/server

    - name: Run Garry's Mod
      run: ./srcds_run_x64 -game garrysmod -systemtest || true
      working-directory: ./gmod/

    - name: Check if tests were successful
      run: mv gmod/tests-success.txt gmod/tests.txt

    - name: Print test log
      run: cat gmod/tests-log.txt

    - name: Upload test log
      uses: actions/upload-artifact@v1.0.0
      with:
        name: Linux-Test-Log
        path: gmod/tests-log.txt

 windows-build:

   runs-on: windows-latest

   steps:
     - name: Checkout
       uses: actions/checkout@v2.0.0

     - name: Setup .NET Core SDK
       uses: actions/setup-dotnet@v1.4.0
       with:
         dotnet-version: '3.1.101'

     - name: Install Cmake
       uses: jwlawson/actions-setup-cmake@v1.0
       with:
         cmake-version: '3.16.x'

     - name: Build Managed part
       run: dotnet publish -c Release
       working-directory: ./gm_dotnet_managed/

     - name: Setup MSBuild
       uses: warrenbuckley/Setup-MSBuild@v1

     - name: Build Native part
       run: |
            mkdir cmake_build
            cd cmake_build
            cmake -G 'Visual Studio 16 2019' -A x64 ../gm_dotnet_native
            msbuild gm_dotnet_native.sln

     - name: Download .NET Runtime
       shell: bash
       run: |
            mkdir build
            cd build
            mkdir dotnet
            cd dotnet
            curl https://download.visualstudio.microsoft.com/download/pr/5db5952d-a6d6-4b48-b9a8-a3f52fb62a9c/80217ca86ef3894db2f8d63bed413b70/aspnetcore-runtime-3.1.1-win-x64.zip -O -L

     - name: Unpack Runtime
       run: |
            cd build/dotnet
            Expand-Archive -LiteralPath ./aspnetcore-runtime-3.1.1-win-x64.zip -DestinationPath ./

     - name: Delete Runtime zip
       shell: bash
       run: |
            cd build/dotnet
            rm -rfv aspnetcore-runtime-3.1.1-win-x64.zip

     - name: Copy build artifacts
       env:
         COMMIT: ${{ github.sha }}
       shell: bash
       run: |
            mkdir build/gmodnet
            mkdir build/gmodnet/API
            cp cmake_build/*.dll build
            cp -a -v gm_dotnet_managed/GmodNET/bin/Release/netcoreapp3.1/publish/. build/gmodnet
            cp gm_dotnet_managed/GmodNET.API/bin/Release/netcoreapp3.1/GmodNET.API.dll build/gmodnet/API
            find build/gmodnet/*.exe | xargs rm -f -v
            rm -f -v build/gmodnet/web.config
            cp LICENSE build
            cp NOTICE build
            cd build
            touch gmodnet-$COMMIT

     - name: Upload build artifacts
       uses: actions/upload-artifact@v1.0.0
       with:
         name: Windows-Raw-Build
         path: ./build
