env:
  - GMODNET_VERSION="0.4.2"

stages:
  - build
  - tests

jobs:
  include:
    - language: cpp
      stage: build
      dist: bionic
      name: Linux builder
      script:
        - wget -q https://packages.microsoft.com/config/ubuntu/18.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
        - sudo dpkg -i packages-microsoft-prod.deb
        - sudo add-apt-repository universe
        - sudo apt-get update
        - sudo apt-get install apt-transport-https
        - sudo apt-get update
        - sudo apt-get install dotnet-sdk-3.0
        - dotnet publish gm_dotnet_managed/GmodNET.API/GmodNET.API.csproj -c Release 
        - dotnet publish gm_dotnet_managed/GmodNET/GmodNET.csproj -c Release
        - mkdir cmake_build
        - cd cmake_build
        - cmake ../gm_dotnet_native
        - make
        - cd ..
        - mkdir build
        - mkdir build/GmodNET
        - mkdir build/GmodNET/API
        - cp cmake_build/*.dll build
        - cp -a -v gm_dotnet_managed/GmodNET/bin/Release/netcoreapp3.0/publish/. build/GmodNET
        - cp gm_dotnet_managed/GmodNET.API/bin/Release/netcoreapp3.0/GmodNET.API.dll build/GmodNET/API
        - find build/GmodNET/*.exe | xargs rm -f -v
        - find build/GmodNET/*.pdb | xargs rm -f -v
        - rm -f -v build/GmodNET/GmodNET
        - rm -f -v build/GmodNET/web.config
        - cd build 
        - mkdir dotnet
        - cd dotnet
        - wget https://download.visualstudio.microsoft.com/download/pr/b0c44e05-b7a1-4221-94ec-a0c0d3a11eed/afc61567dd6db8f097e244871889458c/aspnetcore-runtime-3.0.0-linux-x64.tar.gz
        - tar xvf aspnetcore-runtime-3.0.0-linux-x64.tar.gz
        - rm -f -v aspnetcore-runtime-3.0.0-linux-x64.tar.gz
        - rm -f -v dotnet
        - rm -f -v LICENSE.txt
        - rm -f -v ThirdPartyNotices.txt
        - cd ..
        - cd ..
        - cp LICENSE build
        - cp NOTICE build        
        - git clone https://GlebChili:$GITHUB_TOKEN@github.com/GlebChili/GmodDotNetPrivateKey.git
        - wget https://github.com/GlebChili/GmodNetModuleSigner/releases/download/1.0.0/gms
        - chmod +x gms
        - cd build
        - ./../gms --sign=gmcl_dotnet_linux64.dll --key=../GmodDotNetPrivateKey/gmodnet-private.modulekey --version=$GMODNET_VERSION
        - mv signature.modulesign gmcl_dotnet.modulesign
        - cp ../GmodDotNetPrivateKey/gmodnet-public.modulekey .
        - mv gmodnet-public.modulekey gmcl_dotnet.modulekey
        - cd GmodNET
        - ./../../gms --sign=GmodNET.dll --key=../../GmodDotNetPrivateKey/gmodnet-private.modulekey --version=$GMODNET_VERSION
        - mv signature.modulesign GmodNET.modulesign
        - cp ../../GmodDotNetPrivateKey/gmodnet-public.modulekey .
        - mv gmodnet-public.modulekey GmodNET.modulekey
        - cd ..
        - tar czfv ../$TRAVIS_BRANCH-$TRAVIS_COMMIT.tar.gz .
        - cd ..
        - mkdir files_to_publish
        - cp $TRAVIS_BRANCH-$TRAVIS_COMMIT.tar.gz files_to_publish
      deploy:
        provider: s3
        access_key_id: $SPACE_ID
        secret_access_key: $SPACE_KEY
        bucket: gleb-krasilich
        skip_cleanup: true
        upload-dir: GmodDotNetBuilds/Linux/$TRAVIS_BRANCH
        local_dir: files_to_publish
        acl: public_read
        on:
          all_branches: true
        endpoint: https://fra1.digitaloceanspaces.com
    
    - language: cpp
      stage: build
      os: windows
      name: Windows builder
      script:
        - export MSBUILD_PATH="c:\Program Files (x86)\Microsoft Visual Studio\2017\BuildTools\MSBuild\15.0\Bin"
        - choco install dotnetcore-sdk --version 3.0.100
        - dotnet publish gm_dotnet_managed/GmodNET.API/GmodNET.API.csproj -c Release 
        - dotnet publish gm_dotnet_managed/GmodNET/GmodNET.csproj -c Release
        - mkdir cmake_build
        - cd cmake_build
        - cmake -G 'Visual Studio 15 2017 Win64' ../gm_dotnet_native
        - export PATH=$MSBUILD_PATH:$PATH
        - msbuild.exe gm_dotnet_native.sln
        - cd ..
        - mkdir build
        - mkdir build/GmodNET
        - mkdir build/GmodNET/API
        - cp cmake_build/Release/*.dll build
        - cp -a -v gm_dotnet_managed/GmodNET/bin/Release/netcoreapp3.0/publish/. build/GmodNET
        - cp gm_dotnet_managed/GmodNET.API/bin/Release/netcoreapp3.0/GmodNET.API.dll build/GmodNET/API
        - find build/GmodNET/*.exe | xargs rm -f -v
        - find build/GmodNET/*.pdb | xargs rm -f -v
        - rm -f -v build/GmodNET/web.config
        - cd build
        - mkdir dotnet
        - cd dotnet
        - curl https://download.visualstudio.microsoft.com/download/pr/02a17191-e966-4b89-9312-2cbad04fa8bd/0bd4537f7683f2c4d3986d30bfbb4344/aspnetcore-runtime-3.0.0-win-x64.zip -O -L
        - 7z x -tzip aspnetcore-runtime-3.0.0-win-x64.zip
        - rm -f aspnetcore-runtime-3.0.0-win-x64.zip
        - rm -f dotnet
        - rm -f LICENSE.txt
        - rm -f ThirdPartyNotices.txt
        - cd ..
        - cd ..
        - cp LICENSE build
        - cp NOTICE build
        - git clone https://GlebChili:$GITHUB_TOKEN@github.com/GlebChili/GmodDotNetPrivateKey.git
        - curl https://github.com/GlebChili/GmodNetModuleSigner/releases/download/1.0.0/gms.exe -O -L
        - cd build
        - ./../gms --sign=gmcl_dotnet_win64.dll --key=../GmodDotNetPrivateKey/gmodnet-private.modulekey --version=$GMODNET_VERSION
        - mv signature.modulesign gmcl_dotnet.modulesign
        - cp ../GmodDotNetPrivateKey/gmodnet-public.modulekey .
        - mv gmodnet-public.modulekey gmcl_dotnet.modulekey
        - cd GmodNET
        - ./../../gms --sign=GmodNET.dll --key=../../GmodDotNetPrivateKey/gmodnet-private.modulekey --version=$GMODNET_VERSION
        - mv signature.modulesign GmodNET.modulesign
        - cp ../../GmodDotNetPrivateKey/gmodnet-public.modulekey .
        - mv gmodnet-public.modulekey GmodNET.modulekey
        - cd ../..
        - 7z a -tzip $TRAVIS_BRANCH-$TRAVIS_COMMIT.zip ./build/*
        - mkdir files_to_publish
        - cp $TRAVIS_BRANCH-$TRAVIS_COMMIT.zip files_to_publish
      deploy:
        provider: s3
        edge: true
        access_key_id: $SPACE_ID
        secret_access_key: $SPACE_KEY
        bucket: gleb-krasilich
        skip_cleanup: true
        upload-dir: GmodDotNetBuilds/Windows/$TRAVIS_BRANCH
        local_dir: files_to_publish
        acl: public_read
        on:
          all_branches: true
        endpoint: https://fra1.digitaloceanspaces.com
    
    - language: cpp
      stage: build
      os: osx
      name: Mac builder
      script:
        - curl https://dotnetwebsite.azurewebsites.net/download/dotnet-core/scripts/v1/dotnet-install.sh -O -L
        - chmod +x dotnet-install.sh
        - mkdir dnsdk
        - ./dotnet-install.sh --version 3.0.100 --install-dir dnsdk
        - ./dnsdk/dotnet publish gm_dotnet_managed/GmodNET.API/GmodNET.API.csproj -c Release 
        - ./dnsdk/dotnet publish gm_dotnet_managed/GmodNET/GmodNET.csproj -c Release
        - mkdir cmake_build
        - cd cmake_build
        - cmake ../gm_dotnet_native
        - make
        - cd ..
        - mkdir build
        - mkdir build/GmodNET
        - mkdir build/GmodNET/API
        - cp cmake_build/*.dll build
        - cp -a -v gm_dotnet_managed/GmodNET/bin/Release/netcoreapp3.0/publish/. build/GmodNET
        - cp gm_dotnet_managed/GmodNET.API/bin/Release/netcoreapp3.0/GmodNET.API.dll build/GmodNET/API
        - find build/GmodNET/*.exe | xargs rm -f -v
        - find build/GmodNET/*.pdb | xargs rm -f -v
        - rm -f -v build/GmodNET/GmodNET
        - rm -f -v build/GmodNET/web.config
        - cd build 
        - mkdir dotnet
        - cd dotnet
        - curl https://download.visualstudio.microsoft.com/download/pr/3ab4125a-c616-4aec-8fdb-763039e99f1c/08a6d2546fbbd4b1b959e6a3da3b9eb4/aspnetcore-runtime-3.0.0-osx-x64.tar.gz -O -L
        - tar xvf aspnetcore-runtime-3.0.0-osx-x64.tar.gz
        - rm -f -v aspnetcore-runtime-3.0.0-osx-x64.tar.gz
        - rm -f dotnet
        - rm -f LICENSE.txt
        - rm -f ThirdPartyNotices.txt
        - cd ..
        - cd ..
        - cp LICENSE build
        - cp NOTICE build        
        - git clone https://GlebChili:$GITHUB_TOKEN@github.com/GlebChili/GmodDotNetPrivateKey.git
        - curl https://github.com/GlebChili/GmodNetModuleSigner/releases/download/1.0.0/gms-osx -O -L
        - mv gms-osx gms
        - chmod +x gms
        - cd build
        - ./../gms --sign=gmcl_dotnet_osx64.dll --key=../GmodDotNetPrivateKey/gmodnet-private.modulekey --version=$GMODNET_VERSION
        - mv signature.modulesign gmcl_dotnet.modulesign
        - cp ../GmodDotNetPrivateKey/gmodnet-public.modulekey .
        - mv gmodnet-public.modulekey gmcl_dotnet.modulekey
        - cd GmodNET
        - ./../../gms --sign=GmodNET.dll --key=../../GmodDotNetPrivateKey/gmodnet-private.modulekey --version=$GMODNET_VERSION
        - mv signature.modulesign GmodNET.modulesign
        - cp ../../GmodDotNetPrivateKey/gmodnet-public.modulekey .
        - mv gmodnet-public.modulekey GmodNET.modulekey
        - cd ..
        - tar czfv ../$TRAVIS_BRANCH-$TRAVIS_COMMIT.tar.gz .
        - cd ..
        - mkdir files_to_publish
        - cp $TRAVIS_BRANCH-$TRAVIS_COMMIT.tar.gz files_to_publish
      deploy:
        provider: s3
        access_key_id: $SPACE_ID
        secret_access_key: $SPACE_KEY
        bucket: gleb-krasilich
        skip_cleanup: true
        upload-dir: GmodDotNetBuilds/Osx/$TRAVIS_BRANCH
        local_dir: files_to_publish
        acl: public_read
        on:
          all_branches: true
        endpoint: https://fra1.digitaloceanspaces.com
        
    - language: minimal
      stage: build
      name: Lua assembler
      script: 
        - mkdir folder_to_deploy
        - cp lua/autorun/clientside/gm_dotnet_client.lua folder_to_deploy
        - cp lua/autorun/serverside/gm_dotnet_server.lua folder_to_deploy
      deploy:
        provider: s3
        access_key_id: $SPACE_ID
        secret_access_key: $SPACE_KEY
        bucket: gleb-krasilich
        skip_cleanup: true
        upload-dir: GmodDotNetBuilds/Lua/$TRAVIS_BRANCH/$TRAVIS_COMMIT
        local_dir: folder_to_deploy
        acl: public_read
        on:
          all_branches: true
        endpoint: https://fra1.digitaloceanspaces.com
    
    - language: node_js
      node_js:
        - 12
      stage: tests
      name: Discord notifier
      script:
        - cd node
        - npm update
        - node discord.js $WEBHOOK_URL $TRAVIS_BRANCH $TRAVIS_COMMIT
        
        
      
      
        